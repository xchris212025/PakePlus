<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>随机点名系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#F97316',
            neutral: {
              100: '#F3F4F6',
              200: '#E5E7EB',
              700: '#374151',
              800: '#1F2937',
              900: '#111827'
            }
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .bg-gradient-primary {
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      }
      .transition-bounce-custom {
        transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
    }
  </style>
</head>

<body class="font-inter bg-neutral-100 min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-gradient-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <i class="fa fa-random text-2xl"></i>
        <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold tracking-tight text-shadow">随机点名系统</h1>
      </div>
      <div class="hidden md:flex items-center space-x-4">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/20 transition-colors">
          <i class="fa fa-moon-o"></i>
        </button>
        <button id="help-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
          <i class="fa fa-question-circle"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <!-- 左侧控制面板 -->
      <div class="lg:col-span-1 space-y-6">
        <!-- 文件上传区域 -->
        <div class="bg-white rounded-xl shadow-md p-6 transform hover:shadow-lg transition-all duration-300">
          <h2 class="text-xl font-semibold text-neutral-800 mb-4 flex items-center">
            <i class="fa fa-upload text-primary mr-2"></i>上传学生名单
          </h2>
          <div id="drop-area" class="border-2 border-dashed border-neutral-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-colors">
            <i class="fa fa-file-excel-o text-4xl text-neutral-400 mb-3"></i>
            <p class="text-neutral-600 mb-2">拖放Excel文件到此处，或</p>
            <label class="inline-block bg-primary text-white px-4 py-2 rounded-md cursor-pointer hover:bg-primary/90 transition-colors">
              <input type="file" id="file-input" accept=".xlsx, .xls" class="hidden">
              <i class="fa fa-plus mr-1"></i>选择文件
            </label>
            <p class="mt-3 text-sm text-neutral-500">支持格式：.xlsx, .xls</p>
          </div>
          
          <div id="file-info" class="mt-4 hidden">
            <div class="flex items-center justify-between p-3 bg-neutral-100 rounded-lg">
              <div class="flex items-center">
                <i class="fa fa-file-text-o text-primary mr-2"></i>
                <div>
                  <p id="file-name" class="font-medium text-neutral-800 truncate w-48"></p>
                  <p id="student-count" class="text-sm text-neutral-600">0 名学生</p>
                </div>
              </div>
              <button id="remove-file" class="text-neutral-500 hover:text-red-500 transition-colors">
                <i class="fa fa-times"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- 点名设置 -->
        <div class="bg-white rounded-xl shadow-md p-6 transform hover:shadow-lg transition-all duration-300">
          <h2 class="text-xl font-semibold text-neutral-800 mb-4 flex items-center">
            <i class="fa fa-sliders text-primary mr-2"></i>点名设置
          </h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-neutral-700 mb-1 text-sm font-medium">每次抽取人数</label>
              <div class="relative">
                <input type="number" id="select-count" min="1" value="1" 
                       class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
              </div>
            </div>
            
            <div>
              <label class="block text-neutral-700 mb-1 text-sm font-medium">排除已点到的学生</label>
              <div class="flex items-center">
                <input type="checkbox" id="exclude-selected" class="form-checkbox h-5 w-5 text-primary rounded border-neutral-300 focus:ring-primary">
                <label for="exclude-selected" class="ml-2 text-neutral-700">开启后已点到的学生不会重复出现</label>
              </div>
            </div>
            
            <div>
              <label class="block text-neutral-700 mb-1 text-sm font-medium">点名速度</label>
              <div class="flex items-center space-x-2">
                <i class="fa fa-tachometer text-neutral-500"></i>
                <input type="range" id="speed-control" min="50" max="500" value="200" 
                       class="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-primary">
                <span id="speed-value" class="text-sm text-neutral-600 whitespace-nowrap">中等</span>
              </div>
            </div>
            
            <button id="start-btn" class="w-full bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center space-x-2 shadow-md hover:shadow-lg">
              <i class="fa fa-play"></i>
              <span>开始随机点名</span>
            </button>
          </div>
        </div>
        
        <!-- 已点学生 -->
        <div class="bg-white rounded-xl shadow-md p-6 transform hover:shadow-lg transition-all duration-300">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-neutral-800 flex items-center">
              <i class="fa fa-history text-primary mr-2"></i>已点学生
            </h2>
            <button id="clear-history" class="text-sm text-neutral-500 hover:text-red-500 transition-colors flex items-center">
              <i class="fa fa-trash-o mr-1"></i>清空
            </button>
          </div>
          
          <div id="history-container" class="max-h-60 overflow-y-auto">
            <div id="empty-history" class="py-10 text-center text-neutral-500">
              <i class="fa fa-clock-o text-3xl mb-2"></i>
              <p>暂无点名记录</p>
            </div>
            <ul id="history-list" class="divide-y divide-neutral-200 hidden"></ul>
          </div>
        </div>
      </div>
      
      <!-- 右侧结果展示区 -->
      <div class="lg:col-span-2 space-y-6">
        <!-- 点名结果展示 -->
        <div class="bg-white rounded-xl shadow-md p-6 h-full transform hover:shadow-lg transition-all duration-300 flex flex-col">
          <h2 class="text-xl font-semibold text-neutral-800 mb-6 flex items-center">
            <i class="fa fa-user-circle-o text-primary mr-2"></i>点名结果
          </h2>
          
          <div class="flex-grow flex flex-col items-center justify-center">
            <div id="result-container" class="relative w-full max-w-lg aspect-square mx-auto">
              <div id="name-display" class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-primary/10 to-primary/20 rounded-full shadow-inner">
                <div class="text-center">
                  <p class="text-neutral-500 mb-2">准备就绪</p>
                  <div class="text-[clamp(2rem,5vw,4rem)] font-bold text-neutral-800">点击开始按钮</div>
                </div>
              </div>
              
              <!-- 装饰性元素 -->
              <div class="absolute top-0 left-0 w-10 h-10 bg-primary/20 rounded-full blur-md animate-pulse"></div>
              <div class="absolute bottom-0 right-0 w-12 h-12 bg-secondary/20 rounded-full blur-md animate-pulse" style="animation-delay: 0.5s"></div>
            </div>
            
            <div id="selected-names" class="mt-8 w-full grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
              <!-- 被选中的学生名字会动态添加到这里 -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-neutral-800 text-white py-6 mt-8">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <p class="text-neutral-400">&copy; 2025 随机点名系统 - 让课堂互动更高效</p>
        </div>
        <div class="flex space-x-4">
          <a href="#" class="text-neutral-400 hover:text-white transition-colors">
            <i class="fa fa-github"></i>
          </a>
          <a href="#" class="text-neutral-400 hover:text-white transition-colors">
            <i class="fa fa-twitter"></i>
          </a>
          <a href="#" class="text-neutral-400 hover:text-white transition-colors">
            <i class="fa fa-envelope"></i>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- 帮助模态框 -->
  <div id="help-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-neutral-200">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-bold text-neutral-800">使用帮助</h3>
          <button id="close-help" class="text-neutral-500 hover:text-neutral-800">
            <i class="fa fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div class="space-y-4">
          <div>
            <h4 class="font-semibold text-lg text-neutral-800 mb-2">如何上传学生名单？</h4>
            <p class="text-neutral-600">点击"上传学生名单"区域中的"选择文件"按钮，选择你的Excel文件，或直接将Excel文件拖放到虚线框内。</p>
          </div>
          <div>
            <h4 class="font-semibold text-lg text-neutral-800 mb-2">Excel文件格式要求</h4>
            <p class="text-neutral-600">Excel文件的第一列应为学生姓名。系统会自动识别第一列的所有姓名作为学生名单。</p>
          </div>
          <div>
            <h4 class="font-semibold text-lg text-neutral-800 mb-2">如何开始随机点名？</h4>
            <p class="text-neutral-600">上传学生名单后，设置好每次抽取人数、点名速度等参数，点击"开始随机点名"按钮即可。</p>
          </div>
          <div>
            <h4 class="font-semibold text-lg text-neutral-800 mb-2">如何查看历史记录？</h4>
            <p class="text-neutral-600">在左侧面板的"已点学生"区域可以查看已经被点到的学生记录，点击"清空"按钮可以清除所有记录。</p>
          </div>
        </div>
      </div>
      <div class="p-4 bg-neutral-50 rounded-b-xl">
        <button id="got-it" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90 transition-colors">
          我知道了
        </button>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let students = [];
    let selectedStudents = [];
    let isRolling = false;
    let rollInterval;
    let speed = 200; // 默认速度值
    
    // DOM元素
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const studentCount = document.getElementById('student-count');
    const removeFile = document.getElementById('remove-file');
    const startBtn = document.getElementById('start-btn');
    const nameDisplay = document.getElementById('name-display');
    const selectedNames = document.getElementById('selected-names');
    const selectCount = document.getElementById('select-count');
    const excludeSelected = document.getElementById('exclude-selected');
    const speedControl = document.getElementById('speed-control');
    const speedValue = document.getElementById('speed-value');
    const historyList = document.getElementById('history-list');
    const emptyHistory = document.getElementById('empty-history');
    const clearHistory = document.getElementById('clear-history');
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const closeHelp = document.getElementById('close-help');
    const gotIt = document.getElementById('got-it');
    const themeToggle = document.getElementById('theme-toggle');
    
    // 初始化
    init();
    
    function init() {
      // 恢复历史记录
      const savedHistory = localStorage.getItem('randomNameHistory');
      if (savedHistory) {
        selectedStudents = JSON.parse(savedHistory);
        updateHistoryList();
      }
      
      // 事件监听器
      fileInput.addEventListener('change', handleFileSelect);
      dropArea.addEventListener('dragover', handleDragOver);
      dropArea.addEventListener('dragleave', handleDragLeave);
      dropArea.addEventListener('drop', handleDrop);
      removeFile.addEventListener('click', removeSelectedFile);
      startBtn.addEventListener('click', toggleRolling);
      speedControl.addEventListener('input', updateSpeedDisplay);
      clearHistory.addEventListener('click', clearHistoryList);
      helpBtn.addEventListener('click', showHelpModal);
      closeHelp.addEventListener('click', hideHelpModal);
      gotIt.addEventListener('click', hideHelpModal);
      themeToggle.addEventListener('click', toggleTheme);
      
      // 初始化速度显示
      updateSpeedDisplay();
    }
    
    // 文件处理函数
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        processFile(file);
      }
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      dropArea.classList.add('border-primary');
      dropArea.classList.add('bg-primary/5');
    }
    
    function handleDragLeave() {
      dropArea.classList.remove('border-primary');
      dropArea.classList.remove('bg-primary/5');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      dropArea.classList.remove('border-primary');
      dropArea.classList.remove('bg-primary/5');
      
      const file = e.dataTransfer.files[0];
      if (file) {
        processFile(file);
      }
    }
    
    function processFile(file) {
      // 检查文件类型
      if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
        showNotification('请上传Excel文件 (.xlsx 或 .xls)', 'error');
        return;
      }
      
      // 读取文件
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // 获取第一个工作表
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          
          // 转换为JSON
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // 提取第一列作为学生姓名
          students = jsonData.map(row => row[0]).filter(name => name && typeof name === 'string' && name.trim() !== '');
          
          if (students.length === 0) {
            showNotification('Excel文件中未找到有效学生姓名', 'error');
            return;
          }
          
          // 更新文件信息
          fileName.textContent = file.name;
          studentCount.textContent = `${students.length} 名学生`;
          fileInfo.classList.remove('hidden');
          
          showNotification(`成功导入 ${students.length} 名学生`, 'success');
        } catch (error) {
          console.error('处理Excel文件时出错:', error);
          showNotification('处理Excel文件时出错，请检查文件格式', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }
    
    function removeSelectedFile() {
      fileInput.value = '';
      fileInfo.classList.add('hidden');
      students = [];
      showNotification('已移除文件', 'info');
    }
    
    // 随机点名功能
    function toggleRolling() {
      if (students.length === 0) {
        showNotification('请先上传学生名单', 'error');
        return;
      }
      
      if (isRolling) {
        stopRolling();
      } else {
        startRolling();
      }
    }
    
    function startRolling() {
      isRolling = true;
      startBtn.innerHTML = '<i class="fa fa-stop"></i><span>停止</span>';
      nameDisplay.querySelector('div').classList.add('animate-pulse');
      
      rollInterval = setInterval(() => {
        const availableStudents = excludeSelected.checked 
          ? students.filter(student => !selectedStudents.includes(student)) 
          : students;
        
        if (availableStudents.length === 0) {
          if (excludeSelected.checked) {
            showNotification('所有学生已被点到，将重置已点名单', 'info');
            selectedStudents = [];
            updateHistoryList();
          }
          return;
        }
        
        const randomIndex = Math.floor(Math.random() * availableStudents.length);
        const randomName = availableStudents[randomIndex];
        
        nameDisplay.querySelector('div').innerHTML = `<div class="text-[clamp(2rem,5vw,4rem)] font-bold text-neutral-800">${randomName}</div>`;
      }, speed);
    }
    
    function stopRolling() {
      clearInterval(rollInterval);
      isRolling = false;
      startBtn.innerHTML = '<i class="fa fa-play"></i><span>开始随机点名</span>';
      nameDisplay.querySelector('div').classList.remove('animate-pulse');
      
      // 添加选中的学生
      const count = Math.min(parseInt(selectCount.value) || 1, students.length);
      const availableStudents = excludeSelected.checked 
        ? students.filter(student => !selectedStudents.includes(student)) 
        : students;
      
      if (availableStudents.length === 0) {
        if (excludeSelected.checked) {
          showNotification('所有学生已被点到，将重置已点名单', 'info');
          selectedStudents = [];
          updateHistoryList();
          stopRolling(); // 递归调用以确保正确选择学生
          return;
        }
      }
      
      // 随机选择学生
      const selectedThisTime = [];
      for (let i = 0; i < count && availableStudents.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * availableStudents.length);
        const selectedStudent = availableStudents[randomIndex];
        
        selectedThisTime.push(selectedStudent);
        selectedStudents.push(selectedStudent);
        
        // 从可用学生中移除
        availableStudents.splice(randomIndex, 1);
      }
      
      // 更新显示
      updateSelectedNames(selectedThisTime);
      updateHistoryList();
      
      // 保存历史记录
      localStorage.setItem('randomNameHistory', JSON.stringify(selectedStudents));
    }
    
    function updateSelectedNames(selected) {
      selectedNames.innerHTML = '';
      
      selected.forEach((student, index) => {
        const delay = index * 200; // 每个卡片延迟显示
        
        setTimeout(() => {
          const card = document.createElement('div');
          card.className = 'bg-primary/10 border border-primary/20 rounded-lg p-4 text-center transform transition-all duration-500 opacity-0 translate-y-4';
          card.innerHTML = `
            <div class="text-lg font-semibold text-primary">${student}</div>
            <div class="text-xs text-neutral-500 mt-1">第 ${selectedStudents.length - selected.length + index + 1} 个</div>
          `;
          
          selectedNames.appendChild(card);
          
          // 触发动画
          setTimeout(() => {
            card.classList.remove('opacity-0', 'translate-y-4');
            card.classList.add('opacity-100', 'translate-y-0');
          }, 50);
        }, delay);
      });
    }
    
    // 历史记录管理
    function updateHistoryList() {
      if (selectedStudents.length === 0) {
        historyList.classList.add('hidden');
        emptyHistory.classList.remove('hidden');
        return;
      }
      
      historyList.classList.remove('hidden');
      emptyHistory.classList.add('hidden');
      
      // 清空列表
      historyList.innerHTML = '';
      
      // 添加历史记录项，最新的在前面
      for (let i = selectedStudents.length - 1; i >= 0; i--) {
        const student = selectedStudents[i];
        const listItem = document.createElement('li');
        listItem.className = 'py-3 px-2 hover:bg-neutral-50 rounded-md transition-colors flex justify-between items-center';
        
        // 添加淡入动画
        listItem.style.opacity = '0';
        listItem.style.transform = 'translateY(10px)';
        
        listItem.innerHTML = `
          <div class="flex items-center">
            <span class="inline-block w-6 h-6 rounded-full bg-primary/20 text-primary text-xs flex items-center justify-center mr-2">${i + 1}</span>
            <span class="font-medium">${student}</span>
          </div>
          <span class="text-xs text-neutral-500">${formatTimeAgo(new Date())}</span>
        `;
        
        historyList.appendChild(listItem);
        
        // 触发动画
        setTimeout(() => {
          listItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          listItem.style.opacity = '1';
          listItem.style.transform = 'translateY(0)';
        }, 50 * (selectedStudents.length - i));
      }
    }
    
    function clearHistoryList() {
      if (selectedStudents.length === 0) return;
      
      if (confirm('确定要清空所有历史记录吗？')) {
        selectedStudents = [];
        localStorage.removeItem('randomNameHistory');
        updateHistoryList();
        showNotification('已清空历史记录', 'info');
      }
    }
    
    // 速度控制
    function updateSpeedDisplay() {
      speed = parseInt(speedControl.value);
      
      let speedText;
      if (speed < 100) speedText = '极快';
      else if (speed < 200) speedText = '快速';
      else if (speed < 300) speedText = '中等';
      else if (speed < 400) speedText = '慢速';
      else speedText = '极慢';
      
      speedValue.textContent = speedText;
    }
    
    // 帮助模态框
    function showHelpModal() {
      helpModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function hideHelpModal() {
      helpModal.classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    // 主题切换
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const icon = themeToggle.querySelector('i');
      
      if (icon.classList.contains('fa-moon-o')) {
        icon.classList.remove('fa-moon-o');
        icon.classList.add('fa-sun-o');
      } else {
        icon.classList.remove('fa-sun-o');
        icon.classList.add('fa-moon-o');
      }
      
      // 注意：完整的深色模式需要更多的CSS设置
    }
    
    // 通知功能
    function showNotification(message, type = 'info') {
      // 创建通知元素
      const notification = document.createElement('div');
      
      // 设置样式和内容
      let bgColor, icon;
      switch (type) {
        case 'success':
          bgColor = 'bg-green-500';
          icon = 'fa-check-circle';
          break;
        case 'error':
          bgColor = 'bg-red-500';
          icon = 'fa-exclamation-circle';
          break;
        case 'warning':
          bgColor = 'bg-yellow-500';
          icon = 'fa-exclamation-triangle';
          break;
        default: // info
          bgColor = 'bg-primary';
          icon = 'fa-info-circle';
      }
      
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center transform transition-all duration-500 opacity-0 translate-y-[-20px] z-50`;
      notification.innerHTML = `
        <i class="fa ${icon} mr-2"></i>
        <span>${message}</span>
      `;
      
      // 添加到页面
      document.body.appendChild(notification);
      
      // 触发动画
      setTimeout(() => {
        notification.classList.remove('opacity-0', 'translate-y-[-20px]');
      }, 10);
      
      // 自动关闭
      setTimeout(() => {
        notification.classList.add('opacity-0', 'translate-y-[-20px]');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 500);
      }, 3000);
    }
    
    // 工具函数
    function formatTimeAgo(date) {
      // 简化版本，实际应用中可以使用更复杂的时间格式化
      return '刚刚';
    }
  </script>
</body>
</html>
    